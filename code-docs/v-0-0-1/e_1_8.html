<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>april: Example 8 - Events and event lines</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">april
   &#160;<span id="projectnumber">1.0.0</span>
   </div>
   <div id="projectbrief">...</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.1.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('e_1_8.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Example 8 - Events and event lines </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Events are things that happen in the world. To help generate events the library provides the <a class="el" href="classapril_1_1EventSource.html" title="An event is a way to stimulate agents from a world.">EventSource</a> class. Its inheritants recieve regular calls from the world and may generate events in the world.</p>
<p>The actual events are instances of <a class="el" href="classapril_1_1EventData.html" title="A packet in an EventLine.">EventData</a> or of classes that inherit from it. Once created and set-up they are placed in the world in something called event lines, in the world.</p>
<p>An <a class="el" href="classapril_1_1EventLine.html" title="Buffers between events and sensors.">EventLine</a> is a kind of buffer that may contain a limited number of ordered <a class="el" href="classapril_1_1EventData.html" title="A packet in an EventLine.">EventData</a> instances. Various components (EventSources, Actuators, ... ) post messages to an <a class="el" href="classapril_1_1EventLine.html" title="Buffers between events and sensors.">EventLine</a> using <a class="el" href="classapril_1_1EventLine.html#a9ac25d3692a65cfbf56e7a2481d4d578" title="post activity on this event line">EventLine::postActivity()</a>.</p>
<p>A world may have any number of event lines. Each one is identified by an ID and may be asimilated to a sense :sounds are posted to hearing event line and picked up by specialised <a class="el" href="classapril_1_1Sensor.html" title="Base class for sensors.">Sensor</a> (ear), smells are posted to smell event line and picked up by specialised <a class="el" href="classapril_1_1Sensor.html" title="Base class for sensors.">Sensor</a> (nose) and so on. There is no restriction in that event lines should follow real-world senses - these are only used as examples. The format of the data in <a class="el" href="classapril_1_1EventData.html" title="A packet in an EventLine.">EventData</a> is not part of the specification nor it must be the same in different event lines They may be anything the user whishes. Sensors must be designed flexible enough to survive corrupt data or unknown formats even in well established event lines.</p>
<p>So lets see an example: </p>
<div class="fragment"><div class="line">    EventLine * evline = <span class="keyword">new</span> EventLine( w, IdEventLine );</div>
<div class="line">    w-&gt;start();</div>
<div class="line">    Actor * actor = w-&gt;createActor( IdKind );</div>
<div class="line">    <span class="keywordflow">if</span> ( actor )</div>
<div class="line">    {</div>
<div class="line">        Ev * evsrc = <span class="keyword">static_cast&lt;</span>Ev *<span class="keyword">&gt;</span>( w-&gt;createEvent( IdEvent ) );</div>
<div class="line">        <span class="keywordflow">if</span> ( evsrc != NULL )</div>
<div class="line">        {</div>
<div class="line">            </div>
<div class="line">            <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; 20; i++ )</div>
<div class="line">            {</div>
<div class="line">                w-&gt;advance();</div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line">            DEC_REF(evsrc,evsrc);</div>
<div class="line">        }</div>
<div class="line">        DEC_REF(actor,actor);</div>
<div class="line">    }</div>
<div class="line">    w-&gt;stop();</div>
<div class="line">    DEC_REF(evline,evline);</div>
</div><!-- fragment --><p>So after the initialisation (world and factories) has been done we create an <a class="el" href="classapril_1_1EventLine.html" title="Buffers between events and sensors.">EventLine</a> and assign it an ID. Then we create an actor and an custom <a class="el" href="classapril_1_1EventSource.html" title="An event is a way to stimulate agents from a world.">EventSource</a> and we let the world spin twenty times.</p>
<p>This is our custom event source class: </p>
<div class="fragment"><div class="line"><span class="keyword">class   </span>Ev : <span class="keyword">public</span> EventSource {</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    Ev( World * w ) : EventSource( w ) { </div>
<div class="line">        i = 0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordtype">void</span>        doSteps     ( <span class="keywordtype">int</span> steps ) { </div>
<div class="line">        EventLine * eline = world()-&gt;eventLine( IdEventLine );</div>
<div class="line">        <span class="keywordflow">if</span> ( eline != NULL )</div>
<div class="line">        {</div>
<div class="line">            EventData * ed1 = <span class="keyword">new</span> EventData( world(), 1 );</div>
<div class="line">            ed1-&gt;payload().i_ = i*steps;</div>
<div class="line">            eline-&gt;postActivity( ed1 );</div>
<div class="line">            cout &lt;&lt; <span class="stringliteral">&quot;Posted event with payload &quot;</span> &lt;&lt; i*steps &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">            DEC_REF(ed1,ed1);</div>
<div class="line">            i++;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><p>It recieves time ticks with its doSteps() method. On each tick we create a new <a class="el" href="classapril_1_1EventData.html" title="A packet in an EventLine.">EventData</a> and set some simple data to send. In a real life implementation <a class="el" href="classapril_1_1EventData.html" title="A packet in an EventLine.">EventData</a> may need to be extended for various data types. Notice that welocate the event line using <a class="el" href="classapril_1_1World.html#aa47829c065e443679092524a7ff90bf7" title="used by the EventLine class to insert itself">World::eventLine()</a>.</p>
<p>So on each time tick an event gets generated and posted to a event line. It just so happens that our <a class="el" href="classapril_1_1Actor.html" title="An active ocupier of the world.">Actor</a> has a sensor tuned on this kind of input: </p>
<div class="fragment"><div class="line"><span class="keyword">class </span>Sens : <span class="keyword">public</span> Sensor  {</div>
<div class="line">    EventData * ed_prev;</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    Sens( Actor * a ) : Sensor( a, 1, 10 )</div>
<div class="line">    {</div>
<div class="line">        cout &lt;&lt; <span class="stringliteral">&quot;Created custom sensor;\n&quot;</span>;</div>
<div class="line">        ed_prev = NULL;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordtype">void</span> doSteps(<span class="keywordtype">int</span> )</div>
<div class="line">    {</div>
<div class="line">        EventLine * eline = actor()-&gt;world()-&gt;eventLine( IdEventLine );</div>
<div class="line">        <span class="keywordflow">if</span> ( eline != NULL )</div>
<div class="line">        {</div>
<div class="line">            EventData * ed = eline-&gt;firstEventData();</div>
<div class="line">            EventData * ed_first = ed;</div>
<div class="line">            <span class="keywordflow">while</span> ( ed != NULL )</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> ( ed == ed_prev )</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">                cout &lt;&lt; <span class="stringliteral">&quot;Sensed payload &quot;</span> &lt;&lt; ed-&gt;payload().i_ &lt;&lt; <span class="stringliteral">&quot;;\n&quot;</span>;</div>
<div class="line">                ed = <a class="code" href="april_8h.html#a563a8cb60d3179e15e617b98af001d0a">nextEventData_</a>(ed);</div>
<div class="line">            }</div>
<div class="line">            ed_prev = ed_first;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><p>The actor recieves regulate time ticks that it forwards to its components including our sensor. The sensor obtains a pointer to the event line and iterates the events that it had not seen before.</p>
<p>If you run the program you will see that only a part of the posted events get sensed. This is because the <a class="el" href="classapril_1_1Actor.html" title="An active ocupier of the world.">Actor</a> exhausts its energy and dies half way to the end.</p>
<p><br/>
<br/>
<hr/>
 <table  width="100%">
<tr>
<td align="left"><a class="el" href="e_1_7.html">Example 7 - Creating an actor</a>  </td><td align="center"><a class="el" href="april-core.html">april-core library</a>  </td><td align="right"><a class="el" href="e_1_9.html">Example 9 - Reflexes</a>  </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sat Apr 13 2013 22:26:57 for april by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.1.2 </li>
  </ul>
</div>
</body>
</html>
